<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malt Color Mixer</title>
    <style>
/* https://codepen.io/draber/pen/mdyYLNJ */
[data-preview] {
  height: 10rem;
  margin-bottom: 0.5rem;
  border-radius: var(--border-radius);  
  &::before {
    border-right: 15rem solid white;
  }
}

[data-color-form] {
  width: 30rem;
  margin-right: 2rem;
  .row {
    margin-bottom: 10px;
    line-height: 1.5;
  }
}

[data-control-type="sliders"] {
  border: none;
  padding: 0;
  margin-top: 2rem;
  .slider-control {
    position: relative;
    display: flex;
    align-items: center;
  }

  label {
    width: 2rem;
    display: inline-block;
  }

  .unit {
    padding-left: .3rem;
  }

  input {
    border-radius: var(--border-radius);
    &[type="number"] {
      font-family: var(--regular-font);
      height: 2.2rem;
      width: calc(5ch + 1.7rem);
      margin-left: 1rem;
      text-align: right;
      position: relative;
      &::-webkit-inner-spin-button {
        opacity: 1;
      }
    }

    input[type="range"] {
  /*...Unchanged styles...*/
    &[data-channel="yellow"] {
      background: yellow;
    }
    &[data-channel="orange"] {
      background: orange;
    }
    &[data-channel="red"] {
      background: red;
    }
    &[data-channel="brown"] {
      background: brown;
    }
  }
 }
}

.alpha-bg {
  position: relative;
  border: none;
  &::before {
    content: "";
    display: block;
    z-index: -1;
    width: calc(100% - 0.2rem);
    height: calc(100% - 0.2rem);
    position: absolute;
    left: 0.1rem;
    top: 0.1rem;
    border-radius: inherit;
    background: var(--transparency-bg);
    background-size: 1rem;
  }
  &::after {
    content: "";
    display: block;
    z-index: -1;
    width: 100%;
    height: 100%;
    position: absolute;
    border: 1px var(--border-color) solid;
    border-radius: inherit;
    background: inherit;
  }
}

main {
  display: flex;
  height: 100vh;
  padding: 2rem;
  align-items: center;
  justify-content: center
}

/* basic styling */
body {
  background: #1d1e22;
  color: white;
  font: 16px sans-serif
}

td {
  padding: 2rem 1rem
}

caption {
  text-align:left;
  padding: 2rem 1rem
}

@import url("https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono&display=swap");

:root {
  --background-color: hsl(228, 8%, 12%);
  --text-color: hsl(0, 0%, 85%);
  --border-color: hsl(228, 8%, 20%);
  --transparency-bg: url(data:image/gif;base64,R0lGODlhDAAMAHAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQICgAAACwAAAAADAAMAIDX19f///8CFoQfqYeabNyDMkBQb81Uat85nxguUAEAOw==);
  --border-radius: .3rem;
  --regular-font: Roboto, sans-serif;
  --monospace-font: 'Roboto Mono', monospace;
  --form-field-bg: hsl(0, 0%, 95%);
  --form-field-color: hsl(228, 8%, 12%);
  --link-color: hsl(206, 89%, 45%);
}

html {
  font-size: 62.5%;
  box-sizing: border-box;
}

a {
  color: var(--link-color);
}

*,
*:before,
*:after {
  box-sizing: inherit;
}

body {
  font: 1.4rem/1.5 var(--regular-font);
  background: var(--background-color);
  color: var(--text-color);
  margin: 0;
}

h1 {
  font-size: 2.4rem;
}

input, textarea, pre, select, [data-preview] {
  background: var(--form-field-bg);
  color: var(--form-field-color);
}

code, input, textarea, pre, select, [data-preview] {
  font-family: var(--monospace-font);  
}

input, textarea, pre, select, fieldset, [data-preview] {
  border: .1rem var(--border-color) solid;
}

pre {
  color: hsl(0, 0%, 15%);
  background: hsl(0, 0%, 85%);
  padding: 1rem;
  max-height: calc(100vh - 40px);
  overflow: auto;
}

    </style>

</head>
<body>

<!-- Base Malts -->
<div>
    <h3>Base Malts</h3>
    <label for="baseMalt">Base Malt:</label>
    <input type="range" id="baseMalt" min="0" max="100" step="0.01" value="0" onchange="updateColor()">
    <label for="baseToggle">Include Base Malt:</label>
    <input type="checkbox" id="baseToggle" checked onchange="updateColor()">
</div>

<!-- Specialty Malts -->
<div>
    <h3>Specialty Malts</h3>
    <label for="specialtyMalt">Specialty Malt:</label>
    <input type="range" id="specialtyMalt" min="0" max="100" step="0.01" value="0" onchange="updateColor()">
    <label for="specialtyToggle">Include Specialty Malt:</label>
    <input type="checkbox" id="specialtyToggle" checked onchange="updateColor()">
</div>

<!-- Crystal Malts -->
<div>
    <h3>Crystal Malts</h3>
    <label for="crystalMalt">Crystal Malt:</label>
    <input type="range" id="crystalMalt" min="0" max="100" step="0.01" value="0" onchange="updateColor()">
    <label for="crystalToggle">Include Crystal Malt:</label>
    <input type="checkbox" id="crystalToggle" checked onchange="updateColor()">
</div>

<!-- Roasted Malts -->
<div>
    <h3>Roasted Malts</h3>
    <label for="roastedMalt">Roasted Malt:</label>
    <input type="range" id="roastedMalt" min="0" max="100" step="0.01" value="0" onchange="updateColor()">
    <label for="roastedToggle">Include Roasted Malt:</label>
    <input type="checkbox" id="roastedToggle" checked onchange="updateColor()">
</div>

<!-- Color Display -->
<div id="displayColor" style="width: 200px; height: 200px;"></div>

<script>const malts = {
  "Pils": { "type": "Base", "lovibond": 1.5 },
  "Munich": { "type": "Base", "lovibond": 5 },
  "Vienna": { "type": "Base", "lovibond": 4 },
  "Corn": { "type": "Specialty", "lovibond": 0.5 },
  "Crystal 60": { "type": "Crystal", "lovibond": 60 },
  "Carafa I": { "type": "Roasted", "lovibond": 340 }
};

function updateColor() {
  const baseToggle = document.getElementById('baseToggle').checked;
  const specialtyToggle = document.getElementById('specialtyToggle').checked;
  const crystalToggle = document.getElementById('crystalToggle').checked;
  const roastedToggle = document.getElementById('roastedToggle').checked;

  // Disable/Enable the sliders based on the toggle status
  document.getElementById('baseMalt').disabled = !baseToggle;
  document.getElementById('specialtyMalt').disabled = !specialtyToggle;
  document.getElementById('crystalMalt').disabled = !crystalToggle;
  document.getElementById('roastedMalt').disabled = !roastedToggle;

  // Fetch the slider value if the malt type is toggled on, otherwise use 0
  const baseMaltValue = baseToggle ? parseFloat(document.getElementById('baseMalt').value) / 100 : 0;
  const specialtyMaltValue = specialtyToggle ? parseFloat(document.getElementById('specialtyMalt').value) / 100 : 0;
  const crystalMaltValue = crystalToggle ? parseFloat(document.getElementById('crystalMalt').value) / 100 : 0;
  const roastedMaltValue = roastedToggle ? parseFloat(document.getElementById('roastedMalt').value) / 100 : 0;

  const rgb = getCombinedMaltRgb(baseMaltValue, specialtyMaltValue, crystalMaltValue, roastedMaltValue);

  const displayElement = document.getElementById('displayColor');
  displayElement.style.backgroundColor = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
}

function interpolate(poles, value) {
  if (poles.length === 2) {
      // Linear interpolation
      return {
          c: poles[0].c + value * (poles[1].c - poles[0].c),
          m: poles[0].m + value * (poles[1].m - poles[0].m),
          y: poles[0].y + value * (poles[1].y - poles[0].y),
          k: poles[0].k + value * (poles[1].k - poles[0].k)
      };
  } else if (poles.length === 3) {
      if (value < 0.5) {
          return interpolate([poles[0], poles[1]], value * 2);
      } else {
          return interpolate([poles[1], poles[2]], (value - 0.5) * 2);
      }
  }
}

function getCombinedMaltRgb(baseValue, specialtyValue, crystalValue, roastedValue) {
  const poles = {
      base: [
          { c: 0, m: 0, y: 0.25, k: 0 },
          { c: 0, m: 0, y: 1, k: 0 },
          { c: 0, m: 0.5, y: 1, k: 0 }
      ],
      specialty: [
          { c: 0, m: 0.5, y: 1, k: 0 },
          { c: 0, m: 1, y: 1, k: 0.5 }
      ],
      crystal: [
          { c: 0, m: 0.75, y: 1, k: 0 },
          { c: 0, m: 1, y: 1, k: 0.25 },
          { c: 0, m: 1, y: 1, k: 0.75 }
      ],
      roasted: [
          { c: 0, m: 0.5, y: 1, k: 0.5 },
          { c: 0, m: 1, y: 1, k: 1 }
      ]
  };

  const baseCmyk = interpolate(poles.base, baseValue);
  const specialtyCmyk = interpolate(poles.specialty, specialtyValue);
  const crystalCmyk = interpolate(poles.crystal, crystalValue);
  const roastedCmyk = interpolate(poles.roasted, roastedValue);

  // Combine the CMYK values (simple average for now)
  // Calculate the sum of all malt values.
  const totalValue = baseValue + specialtyValue + crystalValue + roastedValue;
  
  // Avoid division by zero.
  if (totalValue === 0) return cmykToRgb(0, 0, 0, 0);

  // Calculate the proportion of each malt type.
  const baseProportion = baseValue / totalValue;
  const specialtyProportion = specialtyValue / totalValue;
  const crystalProportion = crystalValue / totalValue;
  const roastedProportion = roastedValue / totalValue;

  const combinedCmyk = {
      c: baseCmyk.c * baseProportion + specialtyCmyk.c * specialtyProportion + crystalCmyk.c * crystalProportion + roastedCmyk.c * roastedProportion,
      m: baseCmyk.m * baseProportion + specialtyCmyk.m * specialtyProportion + crystalCmyk.m * crystalProportion + roastedCmyk.m * roastedProportion,
      y: baseCmyk.y * baseProportion + specialtyCmyk.y * specialtyProportion + crystalCmyk.y * crystalProportion + roastedCmyk.y * roastedProportion,
      k: baseCmyk.k * baseProportion + specialtyCmyk.k * specialtyProportion + crystalCmyk.k * crystalProportion + roastedCmyk.k * roastedProportion,
  };

  // Convert CMYK to RGB
  const rgb = cmykToRgb(combinedCmyk.c, combinedCmyk.m, combinedCmyk.y, combinedCmyk.k);
  return rgb;
}

function cmykToRgb(c, m, y, k) {
  const r = 255 * (1 - c) * (1 - k);
  const g = 255 * (1 - m) * (1 - k);
  const b = 255 * (1 - y) * (1 - k);
  return { r: Math.round(r), g: Math.round(g), b: Math.round(b) };
}

function updateSRM() {
  const batchSize = parseFloat(document.getElementById('batchSize').value);
  
  // Ensure we don't divide by zero
  if (batchSize === 0) return;

  let totalSRM = 0; 

  for (let maltName in malts) {
      const weight = parseFloat(document.getElementById(maltName + 'Weight').value);
      totalSRM += (weight * malts[maltName].lovibond) / batchSize;  // Calculating SRM contribution
  }

  setSliderValuesBySRM(totalSRM);

  // Update the color display
  updateColor();
}

function setSliderValuesBySRM(srm) {
  resetSliders(); // Set all sliders to 0 initially
  
  if (srm <= 10) {
      document.getElementById('baseMalt').value = srm * 10; // as slider goes from 0 to 100, not 0 to 10
  } else if (srm <= 20) {
      document.getElementById('baseMalt').value = 100;
      document.getElementById('specialtyMalt').value = (srm - 10) * 10;
  } else if (srm <= 30) {
      document.getElementById('baseMalt').value = 100;
      document.getElementById('specialtyMalt').value = 100;
      document.getElementById('crystalMalt').value = (srm - 20) * 10;
  } else if (srm <= 40) {
      document.getElementById('baseMalt').value = 100;
      document.getElementById('specialtyMalt').value = 100;
      document.getElementById('crystalMalt').value = 100;
      document.getElementById('roastedMalt').value = (srm - 30) * 10;
  } else {
      // All sliders maxed out if SRM exceeds 40
      document.getElementById('baseMalt').value = 100;
      document.getElementById('specialtyMalt').value = 100;
      document.getElementById('crystalMalt').value = 100;
      document.getElementById('roastedMalt').value = 100;
  }
}

function resetSliders() {
  document.getElementById('baseMalt').value = 0;
  document.getElementById('specialtyMalt').value = 0;
  document.getElementById('crystalMalt').value = 0;
  document.getElementById('roastedMalt').value = 0;
}</script>
</body>
</html>
